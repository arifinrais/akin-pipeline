apiVersion: v1
kind: ConfigMap
metadata: 
  name: pipeline-monitor-configmap
data:
  JOB_REDIS_HOST: job-enqueuer-service.default.svc.cluster.local

---

apiVersion: v1
kind: ConfigMap
metadata: 
  name: engine-configmap
data:
  JOB_REDIS_HOST: job-enqueuer-service.default.svc.cluster.local
  RQ_REDIS_HOST: rq-server-service.default.svc.cluster.local
  MINIO_HOST: minio-service.default.svc.cluster.local
  MONGO_URI: mongodb://root:mongo123@mongo-service.default.svc.cluster.local/?authSource=admin&readPreference=primary&appname=Engine%&ssl=false

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
  labels:
    name: minio
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      name: minio
  template:
    metadata:
      name: minio
      labels:
        name: minio
    spec:
      containers:
        - name: minio
          image: minio/minio:RELEASE.2021-07-27T02-40-15Z.fips
          ports:
            - containerPort: 9000
            - containerPort: 9001
          env:
            - name: MINIO_ROOT_USER
              value: minio
            - name: MINIO_ROOT_PASSWORD
              value: minio123
          command: ["server", "/export", "--console-address", "\":9001\""]

---

apiVersion: v1
kind: Service
metadata:
  name: minio-service
  namespace: default
spec:
  type: ClusterIP
  selector:
    name: minio
  ports:
    - name: minio
      port: 9000
      targetPort: 9000
      protocol: TCP

---

apiVersion: v1
kind: Service
metadata:
  name: minio-console-service
  namespace: default
spec:
  type: NodePort
  selector:
    name: minio
  ports:
    - name: minio
      protocol: TCP
      port: 9001
      targetPort: 9001
      nodePort: 30002
---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: job-enqueuer
  labels:
    name: job-enqueuer
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      name: job-enqueuer
  template:
    metadata:
      name: job-enqueuer
      labels:
        name: job-enqueuer
    spec:
      containers:
        - name: job-enqueuer
          image: redislabs/rejson:1.0.7
          ports:
            - containerPort: 6379

---

apiVersion: v1
kind: Service
metadata:
  name: job-enqueuer-service
  namespace: default
spec:
  type: ClusterIP
  selector:
    name: job-enqueuer
  ports:
    - name: job-enqueuer
      port: 6379
      targetPort: 6379
      protocol: TCP

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: rq-server
  labels:
    name: rq-server
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      name: rq-server
  template:
    metadata:
      name: rq-server
      labels:
        name: rq-server
    spec:
      containers:
        - name: rq-server
          image: redis:alpine
          ports:
            - containerPort: 6389
          command: ["redis-server", "--port", "6389"]

---

apiVersion: v1
kind: Service
metadata:
  name: rq-server-service
  namespace: default
spec:
  type: ClusterIP
  selector:
    name: rq-server
  ports:
    - name: rq-server
      port: 6389
      targetPort: 6389
      protocol: TCP

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: rq-scraper
  labels:
    name: rq-scraper
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      name: rq-scraper
  template:
    metadata:
      name: rq-scraper
      labels:
        name: rq-scraper
    spec:
      containers:
        - name: rq-scraper
          image: arifinrais/akin-pipeline:engine-k8
          command: ["python", "main.py", "scrape"]
          envFrom:
            - configMapRef:
                name: engine-configmap

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingestor-engine
  labels:
    name: ingestor-engine
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      name: ingestor-engine
  template:
    metadata:
      name: ingestor-engine
      labels:
        name: ingestor-engine
    spec:
      containers:
        - name: ingestor-engine
          image: arifinrais/akin-pipeline:engine-k8
          command: ["python", "main.py", "ingest"]
          envFrom:
            - configMapRef:
                name: engine-configmap

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: pipeline-monitor
  labels:
    name: pipeline-monitor
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      name: pipeline-monitor
  template:
    metadata:
      name: pipeline-monitor
      labels:
        name: pipeline-monitor
    spec:
      containers:
        - name: pipeline-monitor
          image: arifinrais/akin-pipeline:pipeline-monitor-k8
          ports:
            - containerPort: 5050
          envFrom:
            - configMapRef:
                name: pipeline-monitor-configmap

---

apiVersion: v1
kind: Service
metadata:
  name: pipeline-monitor-service
  namespace: default
spec:
  type: NodePort
  selector:
    name: pipeline-monitor
  ports:
    - name: pipeline-monitor
      protocol: TCP
      port: 5050
      targetPort: 5050
      nodePort: 30001

